# –ê–Ω–∞—Ç–æ–º–∏—è `Dockerfile`

## –ü–ª–æ—Ö–æ–π `Dockerfile`
–ù–∞—á–Ω–µ–º —Å –ø—Ä–∏–º–µ—Ä–∞ –ø–ª–æ—Ö–æ–≥–æ –¥–æ–∫–µ—Ä—Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ –º–æ–∂–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö:
```Dockerfile
FROM ubuntu:latest
ADD . /app
RUN apt-get update
RUN apt-get install -y python3
RUN apt-get install -y python3-pip
RUN pip3 install flask
RUN pip3 install redis
ENV SECRET_KEY=mysupersecretkey123
EXPOSE 5000
CMD python3 /app/app.py
```

–ù–æ –ø–æ—á–µ–º—É –∂–µ –æ–Ω –ø–ª–æ—Ö–æ–π?

## –ü—Ä–æ–±–ª–µ–º—ã
### –ü–µ—Ä–≤–∞—è
–í —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –º–æ–∂–µ–º –∑–∞–º–µ—Ç–∏—Ç—å —Ç–µ–≥ `latest`, –∞ —ç—Ç–æ –∂–µ –≤–æ–æ–±—â–µ –ª–æ—Ç–µ—Ä–µ—è, —Å–µ–≥–æ–¥–Ω—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∞ –∑–∞–≤—Ç—Ä–∞ –æ—Ç–ø—É—Å–∫
–¢–∞–∫ –µ—â–µ –∏ —É–±—É–Ω—Ç—É —Ç—è–∂–µ–ª–∞—è, –Ω—É –∑–∞—á–µ–º!

*–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–æ –Ω–∞–¥–æ?* –ê –≤–æ—Ç —Ç–∞–∫:
```docker
FROM python:3.9-slim-buster
```
–í–µ–¥—å –ø—Ä–æ—â–µ –≤–∑—è—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é Python —Å –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–º –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–æ–º Debian, –∏ –≤–æ–æ–±—â–µ —Ç–æ–ø–æ–≤–æ

### –í—Ç–æ—Ä–∞—è
–ï—Å–ª–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è, –º–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å –ü–Ø–¢–¨–¨ –∫–æ–º–∞–Ω–¥ RUN, –∞ –≤–µ–¥—å –∫–∞–∂–¥–∞—è —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Å–ª–æ–π –≤ –æ–±—Ä–∞–∑–µ, —á—Ç–æ —Ç—É–ø–æ -> —Ç—è–∂–µ–ª–æ -> –º–µ–¥–ª–µ–Ω–Ω–æ

–ê –≤–æ—Ç –∫–∞–∫ –Ω–∞–¥–æ:
```docker
RUN apt-get update && \
    apt-get install -y python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
```

### –¢—Ä–µ—Ç—å—è
–ù—É —ç—Ç–æ –≤–æ–æ–±—â–µ –ø–æ–∑–æ—Ä, —Ç–∞–∫ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å
–£ –Ω–∞—Å –∂–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω —Å–µ–∫—Ä–µ—Ç, —ç—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –≤—Å–µ –∑–∞–∫–æ–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª–∞

–ù–∞–¥–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
```
ENV SECRET_KEY=${SECRET_KEY}
```


## –•–û–†–û–®–ò–ô `Dockerfile`
–í–æ—Ç –∫–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Dockerfile:
```docker
FROM python:3.9-slim-buster

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

ENV SECRET_KEY=${SECRET_KEY}

USER nobody
EXPOSE 5000

CMD ["python3", "app.py"]
```

### –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –∞–ø–≥—Ä–µ–π–¥—ã:
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Python –æ–±—Ä–∞–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
- –ö–æ–ø–∏—Ä—É–µ–º —Å–Ω–∞—á–∞–ª–∞ requirements.txt, —á—Ç–æ–±—ã –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –¥–æ–∫–µ—Ä–∞
- –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù—É –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ö–æ—Ä–æ—à–∏–º–∏ –¥–æ–∫–µ—Ä—Ñ–∞–π–ª–∞–º–∏

### 1 –†–µ—Å—É—Ä—Å—ã
–ó–∞—á–µ–º –¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –∞ –≤–¥—Ä—É–≥ –º–µ–º–æ—Ä–∏ –ª–∏–∫ –∏ –≤—Å–µ
–ù—É –≤–æ—Ç —á—Ç–æ –º—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å:
–ú–∞–∫—Å–∏–º—É–º –ø–∞–º—è—Ç–∏:
```zsh
--memory 5m
```
–ú–∞–∫—Å–∏–º—É–º —Ñ–∞–π–ª–∞ –ø–æ–¥–∫–∞—á–∫–∏:
```zsh
--memory-swap 100m
```
CPU limit:
```zsh
--cpus 2.5
```

### 2 –£–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–π
1. `privileged` –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
–ü–æ –¥–æ–∫–µ, —Ç–∞–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∏—Ç god mode –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –¥–æ–∫–µ—Ä –≤ –¥–æ–∫–µ—Ä–µ


–ê –∫–∞–∫ –Ω–∞–¥–æ?
–ê –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑—Ä–µ—à–∏–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ, –∞ —á—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ - –∑–∞–ø—Ä–µ—Ç–∏–º
*thoughtful*

–ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∏—á—å –ø—Ä–∏–±–µ–≥–Ω–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `--cap-drop` –∏ `--cap-add`
```zsh
docker run
--cap-drop NET_ADMIN
--cap-drop SYS_MODULE
--cap-add SYS_TIME
-ti lab1 /bin/sh
```

# ‚ú®üåüü§©

## `Docker Compose` –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
–ù–∞—á–Ω–µ–º —Å –ø–ª–æ—Ö–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞:
```yml
version: '3'
services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - SECRET_KEY=mysupersecretkey567
    volumes:
      - .:/app
    privileged: true
    
  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always

volumes:
  redis_data:
```

## –ü—Ä–æ–±–ª–µ–º—ã
### –ü–µ—Ä–≤–∞—è:
`privileged: true` –¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ, –∞ —Ç–∞–∫ –Ω–µ –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å

–ê —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –º—ã –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å read_only: true –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ capabilities

### –í—Ç–æ—Ä–∞—è:
–ú–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –ø–æ—Ä—Ç—ã `Redis` –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ

–ê —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `expose` –≤–º–µ—Å—Ç–æ `ports` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏

### –¢—Ä–µ—Ç—å—è:
–ú—ã –º–æ–Ω—Ç–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∏–∑-–∑–∞ `.:/app`

–ù—É –∏ –æ—á–µ–≤–∏–¥–Ω–æ –Ω–∞–¥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã!

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π "–•–æ—Ä–æ—à–∏–π" `docker-compose`
```yml
version: '3.8'
services:
  web:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:5000:5000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    
  redis:
    image: redis:7.0-alpine
    expose:
      - "6379"
    volumes:
      - redis_data:/data:ro
    user: redis
    networks:
      - backend

volumes:
  redis_data:

networks:
  backend:
    internal: true
```

# –ò–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
–ß—Ç–æ–±—ã –≤—Å–µ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–ª–æ, —Å—Ç–æ–∏—Ç –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ–± –∏–∑–æ–ª—è—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤!

## –ü—Ä–∏–º–µ—Ä—ã:
–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ç–∏ (–ø–æ–º–µ—á–∞–µ–º —Å–µ—Ç—å –∫–∞–∫ `internal`)
```yml
networks:
  backend:
    internal: true
```

–î–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–º (–≤–º–µ—Å—Ç–æ `ports` —É–∫–∞–∂–µ–º –∫–∞–∫–æ–π –Ω–∏–±—É–¥—å —Ö–∞—Ä–¥ –ø–æ—Ä—Ç)
```yml
expose:
  - "5677"
```

–ù–∞–∏–º–µ–Ω—å—à–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ (–≤—Å–µ –∏ —Ç–∞–∫ –ø–æ–Ω—è—Ç–Ω–æ)
```yml
security_opt:
  - no-new-privileges:true
cap_drop:
  - ALL
```

# –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–í—Å–ø–æ–º–Ω–∏–ª —á—Ç–æ —Ç–∞–∫–æ–µ –¥–æ–∫–µ—Ä –∏ –ø–æ—á–µ–º—É –æ–Ω –º–Ω–µ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è! –ù–æ –≤ —Ü–µ–ª–æ–º –ª–∞–±–∞ –æ—á –ø—Ä–∏–∫–æ–ª—å–Ω–∞—è (–≥–æ–≤–æ—Ä—é –Ω–µ —á—Ç–æ–± –ø–æ–¥–º–∞–∑–∞—Ç—å—Å—è, –∞ —Ä–µ–∞–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç good/bad practices –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä—è–º –ø–æ–∫–æ–ø–∞—Ç—å—Å—è –∏ –≤–Ω–∏–∫–Ω—É—Ç—å). –º–Ω–µ –ø–æ–Ω—Ä–∞–≤